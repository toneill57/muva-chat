#!/bin/bash
# Parche manual definitivo CVE-2025-55182

echo "╔═══════════════════════════════════════╗"
echo "║   PARCHE CVE-2025-55182 (MANUAL)     ║"
echo "╚═══════════════════════════════════════╝"
echo ""

cd /var/www/muva-chat-tst

echo "1. Limpiando cache y node_modules..."
rm -rf node_modules .next
rm -rf ~/.local/share/pnpm
rm -rf /tmp/.local/share/pnpm
echo "✓ Limpieza completa"
echo ""

echo "2. Instalando versiones parcheadas..."
pnpm install react@19.2.1 react-dom@19.2.1 next@15.5.7
echo ""

echo "3. Verificando instalación:"
grep -E '"next"|"react"' package.json
echo ""

echo "4. Rebuild completo..."
pnpm run build
echo ""

echo "5. Reiniciando aplicación..."
pm2 delete all
pm2 start npm --name "muva-chat" -- start
pm2 save
echo ""

echo "6. Estado final:"
pm2 status
echo ""

echo "╔═══════════════════════════════════════╗"
echo "║   VERIFICACIÓN FINAL                 ║"
echo "╚═══════════════════════════════════════╝"
echo ""
grep -E '"next"|"react"' package.json
