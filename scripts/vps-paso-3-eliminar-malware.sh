#!/bin/bash
# PASO 3: Eliminar malware definitivamente

echo "╔═══════════════════════════════════════╗"
echo "║   ELIMINANDO MALWARE                 ║"
echo "╚═══════════════════════════════════════╝"
echo ""

# 1. Detener y eliminar servicios maliciosos
echo "1. Deteniendo servicios maliciosos..."
systemctl stop alive.service lived.service 2>/dev/null || true
systemctl disable alive.service lived.service 2>/dev/null || true
rm -f /etc/systemd/system/alive.service
rm -f /etc/systemd/system/lived.service
systemctl daemon-reload
echo "✓ Servicios eliminados"
echo ""

# 2. Eliminar binarios maliciosos
echo "2. Eliminando binarios..."
rm -f /usr/local/bin/systemhelper
rm -f /usr/local/bin/syshelper
rm -rf /tmp/runnv/
echo "✓ Binarios eliminados"
echo ""

# 3. Limpiar cron jobs maliciosos
echo "3. Limpiando cron jobs..."
rm -f /etc/cron.d/syshelper
rm -f /etc/cron.d/systemhelper
echo "✓ Cron jobs eliminados"
echo ""

# 4. Verificar que no queden procesos
echo "4. Verificando procesos residuales..."
pkill -9 -f 'alive.sh|lived.sh|systemhelper|syshelper|runnv' 2>/dev/null || true
echo "✓ Procesos terminados"
echo ""

# 5. Limpiar directorios temporales
echo "5. Limpiando temporales..."
find /tmp -type f -executable -delete 2>/dev/null || true
find /var/tmp -type f -executable -delete 2>/dev/null || true
echo "✓ Temporales limpiados"
echo ""

# 6. Verificación final
echo "6. Verificación final..."
echo ""
echo "=== SERVICIOS ELIMINADOS ==="
ls -la /etc/systemd/system/alive.service /etc/systemd/system/lived.service 2>&1 || echo "✓ No existen"
echo ""
echo "=== BINARIOS ELIMINADOS ==="
ls -la /usr/local/bin/systemhelper /usr/local/bin/syshelper 2>&1 || echo "✓ No existen"
echo ""
echo "=== CRON JOBS ELIMINADOS ==="
ls -la /etc/cron.d/syshelper /etc/cron.d/systemhelper 2>&1 || echo "✓ No existen"
echo ""
echo "=== PROCESOS ACTIVOS ==="
ps aux | grep -E 'alive|lived|systemhelper|runnv' | grep -v grep || echo "✓ Ninguno"
echo ""

echo "╔═══════════════════════════════════════╗"
echo "║   LIMPIEZA COMPLETADA                ║"
echo "╚═══════════════════════════════════════╝"
