name: Restart PM2 with Node 20

on:
  workflow_dispatch:

jobs:
  restart:
    runs-on: ubuntu-latest
    steps:
      - name: Restart PM2 completely
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_VPS_HOST }}
          username: ${{ secrets.PROD_VPS_USER }}
          key: ${{ secrets.PROD_VPS_SSH_KEY }}
          port: 2244
          command_timeout: 5m
          script: |
            echo "=== Stopping all PM2 processes ==="
            pm2 stop all

            echo ""
            echo "=== Deleting all PM2 processes ==="
            pm2 delete all

            echo ""
            echo "=== Killing PM2 daemon ==="
            pm2 kill

            echo ""
            echo "=== Verifying Node version ==="
            node --version

            echo ""
            echo "=== Starting production process with Node 20 ==="
            cd /var/www/muva-chat-prd
            pm2 start ecosystem.config.js --only muva-chat-prd
            pm2 save

            echo ""
            echo "=== Starting staging process with Node 20 ==="
            cd /var/www/muva-chat-tst
            pm2 start ecosystem.config.js --only muva-chat-tst
            pm2 save

            echo ""
            echo "=== PM2 Status ==="
            pm2 list
            pm2 info muva-chat-prd
