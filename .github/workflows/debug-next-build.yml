name: Debug Next.js Build

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Debug build with verbose output
        uses: appleboy/ssh-action@v1.0.0
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          host: ${{ secrets.PROD_VPS_HOST }}
          username: ${{ secrets.PROD_VPS_USER }}
          key: ${{ secrets.PROD_VPS_SSH_KEY }}
          port: 2244
          command_timeout: 15m
          envs: OPENAI_API_KEY,ANTHROPIC_API_KEY
          script: |
            cd /var/www/muva-chat-prd

            echo "=== Creating .env.local ==="
            {
              echo "# Supabase - PRODUCTION DATABASE (ooaumjzaztmutltifhoq)"
              echo "NEXT_PUBLIC_SUPABASE_URL=https://ooaumjzaztmutltifhoq.supabase.co"
              echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vYXVtanphenRtdXRsdGlmaG9xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NTQyMDksImV4cCI6MjA3MjQzMDIwOX0.HapBSfCjxBuUijFQvQIgu8Y44YI3OPL6Gr45RKTw-Fk"
              echo "SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vYXVtanphenRtdXRsdGlmaG9xIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Njg1NDIwOSwiZXhwIjoyMDcyNDMwMjA5fQ.ngQSR4E9UHWLcbDAhi0QJy3ffriuV2bi4rGxyHy8Eoc"
              echo ""
              echo "# AI APIs"
              echo "OPENAI_API_KEY=$OPENAI_API_KEY"
              echo "ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY"
              echo ""
              echo "# JWT (PRODUCTION SPECIFIC)"
              echo "JWT_SECRET_KEY=LGqZ/SgchZzT8Oee99uPP5FljEewJFC+2pUSEzEAc6firJoKk2JBxWNicAf7Hm6aZ25pTZDQE7nWaSfC/Ndidg=="
              echo ""
              echo "# Node Environment"
              echo "NODE_ENV=production"
            } > .env.local

            echo ""
            echo "=== Testing Next.js build with DEBUG output ==="
            DEBUG=* NODE_OPTIONS="--trace-warnings --trace-deprecation" pnpm run build 2>&1 || true

            echo ""
            echo "=== Checking Next.js config ==="
            cat next.config.ts 2>/dev/null || cat next.config.js 2>/dev/null || cat next.config.mjs 2>/dev/null || echo "No Next config found"

            echo ""
            echo "=== Checking if .next was created ==="
            ls -la .next/ 2>/dev/null || echo "No .next directory"

            echo ""
            echo "=== Last 50 lines of any error logs ==="
            tail -50 .next/trace 2>/dev/null || echo "No trace file"
