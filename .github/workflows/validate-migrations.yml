name: Validate Migrations Sync

on:
  pull_request:
    branches: [dev, tst, prd]
  push:
    branches: [dev, tst, prd]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Count migration files
        id: count
        run: |
          MIGRATIONS=$(find migrations -name "*.sql" -type f | wc -l)
          SUPABASE=$(find supabase/migrations -name "*.sql" -type f | wc -l)
          echo "migrations=$MIGRATIONS" >> $GITHUB_OUTPUT
          echo "supabase=$SUPABASE" >> $GITHUB_OUTPUT

      - name: Validate counts match
        run: |
          if [ "${{ steps.count.outputs.migrations }}" != "${{ steps.count.outputs.supabase }}" ]; then
            echo "❌ Migration count mismatch!"
            echo "   /migrations: ${{ steps.count.outputs.migrations }}"
            echo "   /supabase/migrations: ${{ steps.count.outputs.supabase }}"
            exit 1
          fi
          echo "✅ Counts match: ${{ steps.count.outputs.migrations }} migrations"

      - name: Setup Node.js
        if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/tst' || github.ref == 'refs/heads/prd'
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Validate database sync (DEV)
        if: github.ref == 'refs/heads/dev'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: zpyxgkvonrxbhvmkuzlt
        run: |
          DB_COUNT=$(node .claude/db-query.js "SELECT COUNT(*) as count FROM supabase_migrations.schema_migrations" | grep -oE '"count":\s*[0-9]+' | grep -oE '[0-9]+')
          REPO_COUNT=$(find supabase/migrations -name "*.sql" -type f | wc -l)

          echo "Database migrations: $DB_COUNT"
          echo "Repository files: $REPO_COUNT"

          if [ "$DB_COUNT" != "$REPO_COUNT" ]; then
            echo "❌ Database/Repo mismatch!"
            echo "   Database: $DB_COUNT migrations"
            echo "   Repo: $REPO_COUNT files"
            exit 1
          fi
          echo "✅ DEV database in sync with repository"

      - name: Validate database sync (TST)
        if: github.ref == 'refs/heads/tst'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: bddcvjoeoiekzfetvxoe
        run: |
          DB_COUNT=$(node .claude/db-query.js tst "SELECT COUNT(*) as count FROM supabase_migrations.schema_migrations" | grep -oE '"count":\s*[0-9]+' | grep -oE '[0-9]+')
          REPO_COUNT=$(find supabase/migrations -name "*.sql" -type f | wc -l)

          echo "Database migrations: $DB_COUNT"
          echo "Repository files: $REPO_COUNT"

          if [ "$DB_COUNT" != "$REPO_COUNT" ]; then
            echo "❌ Database/Repo mismatch!"
            echo "   Database: $DB_COUNT migrations"
            echo "   Repo: $REPO_COUNT files"
            exit 1
          fi
          echo "✅ TST database in sync with repository"
