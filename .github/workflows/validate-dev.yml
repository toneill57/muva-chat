name: Validate Dev Branch

# Trigger: This workflow runs on every push to the 'dev' branch
# Purpose: Validate code quality WITHOUT deploying (dev is local-only)
on:
  push:
    branches:
      - dev

jobs:
  # Job 1: Build Validation
  # Ensures the Next.js application builds successfully
  build:
    runs-on: ubuntu-latest
    name: Build Validation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm run build
        env:
          # Use dev environment variables for build validation
          NODE_ENV: production
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.DEV_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.DEV_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.DEV_SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          NEXT_PUBLIC_APP_URL: https://dev.muva-chat.local
          NEXT_PUBLIC_PLAUSIBLE_DOMAIN: dev.muva-chat.local

      - name: Build success notification
        if: success()
        run: |
          echo "‚úÖ Build validation PASSED"
          echo "üì¶ Next.js build completed successfully"

      - name: Build failure notification
        if: failure()
        run: |
          echo "‚ùå Build validation FAILED"
          echo "üîß Please fix TypeScript/build errors before merging to staging"
          exit 1

  # Job 2: Test Validation
  # Runs unit tests and E2E tests (if they exist)
  test:
    runs-on: ubuntu-latest
    name: Test Validation
    needs: build  # Run after build succeeds

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: |
          if [ -f "jest.config.js" ] || [ -f "jest.config.ts" ]; then
            echo "Running unit tests with Jest..."
            pnpm run test:ci || echo "‚ö†Ô∏è  Tests failed or not configured"
          else
            echo "‚ÑπÔ∏è  No Jest config found, skipping unit tests"
          fi
        env:
          NODE_ENV: test
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.DEV_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.DEV_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.DEV_SUPABASE_SERVICE_ROLE_KEY }}

      - name: Test validation summary
        if: success()
        run: |
          echo "‚úÖ Test validation PASSED"
          echo "üß™ All tests completed successfully"

  # Job 3: Migration Validation
  # Validates SQL migration files WITHOUT executing them
  validate-migrations:
    runs-on: ubuntu-latest
    name: Migration Validation
    needs: build  # Run after build succeeds

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install tsx (TypeScript executor)
        run: pnpm add -g tsx

      - name: Validate migration syntax
        run: |
          echo "Validating SQL migration files..."
          if [ -f "scripts/validate-migrations.ts" ]; then
            pnpm dlx tsx scripts/validate-migrations.ts
          else
            echo "‚ö†Ô∏è  Migration validator script not found, skipping"
          fi

      - name: Check migration conflicts
        run: |
          echo "Checking for migration conflicts..."
          if [ -f "scripts/check-migration-conflicts.ts" ]; then
            pnpm dlx tsx scripts/check-migration-conflicts.ts
          else
            echo "‚ö†Ô∏è  Migration conflict checker not found, skipping"
          fi

      - name: Migration validation summary
        if: success()
        run: |
          echo "‚úÖ Migration validation PASSED"
          echo "üìù All SQL files are valid and conflict-free"

      - name: Migration validation failure
        if: failure()
        run: |
          echo "‚ùå Migration validation FAILED"
          echo "üîß Please fix SQL syntax errors or resolve timestamp conflicts"
          exit 1

  # Summary job: Runs after all checks complete
  summary:
    runs-on: ubuntu-latest
    name: Validation Summary
    needs: [build, test, validate-migrations]
    if: always()  # Run even if previous jobs fail

    steps:
      - name: Validation complete
        run: |
          echo "================================================"
          echo "üéØ DEV BRANCH VALIDATION COMPLETE"
          echo "================================================"
          echo ""
          echo "Status summary:"
          echo "- Build: ${{ needs.build.result }}"
          echo "- Tests: ${{ needs.test.result }}"
          echo "- Migrations: ${{ needs.validate-migrations.result }}"
          echo ""
          if [ "${{ needs.build.result }}" == "success" ] && \
             [ "${{ needs.test.result }}" == "success" ] && \
             [ "${{ needs.validate-migrations.result }}" == "success" ]; then
            echo "‚úÖ All validations PASSED - ready to merge to staging"
            echo "================================================"
          else
            echo "‚ùå Some validations FAILED - fix issues before merging"
            echo "================================================"
            exit 1
          fi
