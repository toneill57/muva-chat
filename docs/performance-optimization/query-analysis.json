{
  "generatedAt": "2025-11-06T06:08:40.509Z",
  "summary": {
    "totalFiles": 19,
    "totalQueries": 39,
    "queriesByType": {
      "rpc": 32,
      "select": 7
    },
    "highRiskPatterns": 20,
    "potentialN1Issues": 7,
    "recommendations": [
      "ðŸš¨ Found 7 files with potential N+1 query patterns",
      "   â†’ Use Promise.all() to parallelize independent queries",
      "   â†’ Use JOINs instead of separate queries",
      "   â†’ Consider batch loading with DataLoader pattern",
      "ðŸ“Š Heavy RPC usage detected (32 calls)",
      "   â†’ Review RPC function performance with EXPLAIN ANALYZE",
      "   â†’ Consider adding indexes for common query patterns"
    ]
  },
  "analyses": [
    {
      "file": "src/lib/integrations/motopress/sync-manager.ts",
      "queries": [
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/integrations/motopress/sync-manager.ts",
          "line": 221,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data: existingResult, error: selectError } = await this.supabase.rpc('exec_sql', {",
          "risk": "high",
          "issue": "Potential N+1: Query inside loop with await"
        },
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/integrations/motopress/sync-manager.ts",
          "line": 258,
          "type": "rpc",
          "method": "rpc",
          "code": "const { error: updateError } = await this.supabase.rpc('exec_sql', { sql: updateSql })",
          "risk": "high",
          "issue": "Potential N+1: Query inside loop with await"
        },
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/integrations/motopress/sync-manager.ts",
          "line": 312,
          "type": "rpc",
          "method": "rpc",
          "code": "const { error: insertError } = await this.supabase.rpc('exec_sql', { sql: insertSql })",
          "risk": "high",
          "issue": "Potential N+1: Query inside loop with await"
        },
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/integrations/motopress/sync-manager.ts",
          "line": 758,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data: existingResult, error: selectError } = await this.supabase.rpc('exec_sql', {",
          "risk": "high",
          "issue": "Potential N+1: Query inside loop with await"
        },
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/integrations/motopress/sync-manager.ts",
          "line": 795,
          "type": "rpc",
          "method": "rpc",
          "code": "const { error: updateError } = await this.supabase.rpc('exec_sql', { sql: updateSql })",
          "risk": "high",
          "issue": "Potential N+1: Query inside loop with await"
        },
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/integrations/motopress/sync-manager.ts",
          "line": 849,
          "type": "rpc",
          "method": "rpc",
          "code": "const { error: insertError } = await this.supabase.rpc('exec_sql', { sql: insertSql })",
          "risk": "high",
          "issue": "Potential N+1: Query inside loop with await"
        }
      ],
      "loops": 7,
      "potentialN1": true
    },
    {
      "file": "src/lib/staff-chat-engine.ts",
      "queries": [
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/staff-chat-engine.ts",
          "line": 1135,
          "type": "select",
          "table": "staff_messages",
          "method": "from",
          "code": "await supabase.from('staff_messages').insert({",
          "risk": "low"
        },
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/staff-chat-engine.ts",
          "line": 1143,
          "type": "select",
          "table": "staff_messages",
          "method": "from",
          "code": "await supabase.from('staff_messages').insert({",
          "risk": "low"
        },
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/staff-chat-engine.ts",
          "line": 741,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data, error } = await supabase.rpc('match_hotel_operations_balanced', {",
          "risk": "low"
        },
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/staff-chat-engine.ts",
          "line": 789,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data, error } = await supabase.rpc('match_hotel_operations_balanced', {",
          "risk": "low"
        },
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/staff-chat-engine.ts",
          "line": 829,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data, error } = await supabase.rpc('match_sire_documents', {",
          "risk": "low"
        },
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/staff-chat-engine.ts",
          "line": 866,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data, error } = await supabase.rpc('match_policies', {",
          "risk": "low"
        }
      ],
      "loops": 19,
      "potentialN1": false
    },
    {
      "file": "src/lib/public-chat-search.ts",
      "queries": [
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/public-chat-search.ts",
          "line": 154,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data, error } = await supabase.rpc('match_accommodations_hybrid', {",
          "risk": "high",
          "issue": "Potential N+1: Query inside loop with await"
        },
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/public-chat-search.ts",
          "line": 217,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data, error } = await supabase.rpc('match_policies_public', {",
          "risk": "high",
          "issue": "Potential N+1: Query inside loop with await"
        },
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/public-chat-search.ts",
          "line": 264,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data, error } = await supabase.rpc('match_muva_documents_public', {",
          "risk": "high",
          "issue": "Potential N+1: Query inside loop with await"
        }
      ],
      "loops": 3,
      "potentialN1": true
    },
    {
      "file": "src/lib/dev-chat-search.ts",
      "queries": [
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/dev-chat-search.ts",
          "line": 156,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data, error } = await supabase.rpc('match_accommodations_hybrid', {",
          "risk": "high",
          "issue": "Potential N+1: Query inside loop with await"
        },
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/dev-chat-search.ts",
          "line": 219,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data, error } = await supabase.rpc('match_policies_public', {",
          "risk": "high",
          "issue": "Potential N+1: Query inside loop with await"
        },
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/dev-chat-search.ts",
          "line": 294,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data, error } = await supabase.rpc('match_muva_documents_public', {",
          "risk": "high",
          "issue": "Potential N+1: Query inside loop with await"
        }
      ],
      "loops": 3,
      "potentialN1": true
    },
    {
      "file": "src/lib/integrations/motopress/bookings-mapper.ts",
      "queries": [
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/integrations/motopress/bookings-mapper.ts",
          "line": 173,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data: units, error } = await supabase.rpc('get_accommodation_unit_by_motopress_id', {",
          "risk": "high",
          "issue": "Potential N+1: Query inside loop with await"
        },
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/integrations/motopress/bookings-mapper.ts",
          "line": 340,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data: units, error } = await supabase.rpc('get_accommodation_unit_by_motopress_id', {",
          "risk": "high",
          "issue": "Potential N+1: Query inside loop with await"
        },
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/integrations/motopress/bookings-mapper.ts",
          "line": 529,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data: units, error } = await supabase.rpc('get_accommodation_unit_by_motopress_id', {",
          "risk": "high",
          "issue": "Potential N+1: Query inside loop with await"
        }
      ],
      "loops": 3,
      "potentialN1": true
    },
    {
      "file": "src/lib/integrations/ics/sync-manager.ts",
      "queries": [
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/integrations/ics/sync-manager.ts",
          "line": 397,
          "type": "select",
          "table": "calendar_events",
          "method": "from",
          "code": "const { error } = await this.supabase.from('calendar_events').insert({",
          "risk": "high",
          "issue": "Potential N+1: Query inside loop with await"
        },
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/integrations/ics/sync-manager.ts",
          "line": 532,
          "type": "select",
          "table": "calendar_event_conflicts",
          "method": "from",
          "code": "const { error } = await this.supabase.from('calendar_event_conflicts').insert({",
          "risk": "high",
          "issue": "Potential N+1: Query inside loop with await"
        },
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/integrations/ics/sync-manager.ts",
          "line": 633,
          "type": "select",
          "table": "calendar_sync_logs",
          "method": "from",
          "code": "await this.supabase.from('calendar_sync_logs').insert({",
          "risk": "high",
          "issue": "Potential N+1: Query inside loop with await"
        }
      ],
      "loops": 4,
      "potentialN1": true
    },
    {
      "file": "src/lib/supabase.ts",
      "queries": [
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/supabase.ts",
          "line": 73,
          "type": "rpc",
          "method": "rpc",
          "code": "* - For SIRE: supabase.rpc('match_sire_documents', {...})",
          "risk": "low"
        },
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/supabase.ts",
          "line": 74,
          "type": "rpc",
          "method": "rpc",
          "code": "* - For MUVA: supabase.rpc('match_muva_documents', {...})",
          "risk": "low"
        }
      ],
      "loops": 0,
      "potentialN1": false
    },
    {
      "file": "src/app/api/guest/chat/route.ts",
      "queries": [
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/app/api/guest/chat/route.ts",
          "line": 149,
          "type": "select",
          "table": "chat_messages",
          "method": "from",
          "code": "const { error: saveError } = await supabase.from('chat_messages').insert({",
          "risk": "low"
        },
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/app/api/guest/chat/route.ts",
          "line": 198,
          "type": "select",
          "table": "chat_messages",
          "method": "from",
          "code": "const { error: saveResponseError } = await supabase.from('chat_messages').insert({",
          "risk": "low"
        }
      ],
      "loops": 1,
      "potentialN1": false
    },
    {
      "file": "src/lib/conversation-memory-search.ts",
      "queries": [
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/conversation-memory-search.ts",
          "line": 78,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data, error } = await supabase.rpc('match_conversation_memory', {",
          "risk": "high",
          "issue": "Potential N+1: Query inside loop with await"
        }
      ],
      "loops": 1,
      "potentialN1": true
    },
    {
      "file": "src/app/api/integrations/motopress/sync-all/route.ts",
      "queries": [
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/app/api/integrations/motopress/sync-all/route.ts",
          "line": 351,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data: units } = await supabase.rpc('get_accommodation_unit_by_motopress_id', {",
          "risk": "high",
          "issue": "Potential N+1: Query inside loop with await"
        }
      ],
      "loops": 4,
      "potentialN1": true
    },
    {
      "file": "src/lib/vector-search/unit-manual.ts",
      "queries": [
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/vector-search/unit-manual.ts",
          "line": 35,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data, error } = await supabase.rpc('match_unit_manual_chunks', {",
          "risk": "low"
        }
      ],
      "loops": 2,
      "potentialN1": false
    },
    {
      "file": "src/lib/vector-search/muva.ts",
      "queries": [
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/vector-search/muva.ts",
          "line": 26,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data, error } = await supabase.rpc('match_muva_documents', {",
          "risk": "low"
        }
      ],
      "loops": 1,
      "potentialN1": false
    },
    {
      "file": "src/lib/vector-search/hotel.ts",
      "queries": [
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/lib/vector-search/hotel.ts",
          "line": 29,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data, error } = await supabase.rpc('match_hotel_general_info', {",
          "risk": "low"
        }
      ],
      "loops": 1,
      "potentialN1": false
    },
    {
      "file": "src/app/api/sire/statistics/route.ts",
      "queries": [
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/app/api/sire/statistics/route.ts",
          "line": 154,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data, error } = await supabase.rpc('get_sire_statistics', {",
          "risk": "low"
        }
      ],
      "loops": 0,
      "potentialN1": false
    },
    {
      "file": "src/app/api/sire/monthly-export/route.ts",
      "queries": [
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/app/api/sire/monthly-export/route.ts",
          "line": 190,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data, error } = await supabase.rpc('get_sire_monthly_export', {",
          "risk": "low"
        }
      ],
      "loops": 0,
      "potentialN1": false
    },
    {
      "file": "src/app/api/sire/guest-data/route.ts",
      "queries": [
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/app/api/sire/guest-data/route.ts",
          "line": 145,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data, error } = await supabase.rpc('get_sire_guest_data', {",
          "risk": "low"
        }
      ],
      "loops": 0,
      "potentialN1": false
    },
    {
      "file": "src/app/api/sire/data-completeness/route.ts",
      "queries": [
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/app/api/sire/data-completeness/route.ts",
          "line": 148,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data, error } = await supabase.rpc('check_sire_data_completeness', {",
          "risk": "low"
        }
      ],
      "loops": 0,
      "potentialN1": false
    },
    {
      "file": "src/app/api/health/guest-chat/route.ts",
      "queries": [
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/app/api/health/guest-chat/route.ts",
          "line": 211,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data, error } = await supabase.rpc('match_unit_manual_chunks', {",
          "risk": "low"
        }
      ],
      "loops": 2,
      "potentialN1": false
    },
    {
      "file": "src/app/api/accommodation/units/route.ts",
      "queries": [
        {
          "file": "/Users/oneill/Sites/apps/muva-chat/src/app/api/accommodation/units/route.ts",
          "line": 34,
          "type": "rpc",
          "method": "rpc",
          "code": "const { data: units, error } = await supabase.rpc('get_accommodation_units', {",
          "risk": "low"
        }
      ],
      "loops": 1,
      "potentialN1": false
    }
  ]
}