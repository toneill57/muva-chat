flowchart TD
    A[Guest Login] --> B{Valid Credentials?}
    B -->|No| A
    B -->|Yes| C[Fetch Reservation]

    C --> D[Get Accommodation Units]
    D --> E{Multi-Room?}
    E -->|Yes| F[Load ALL Units Data]
    E -->|No| G[Load Single Unit Data]

    F --> H[Create Guest Session]
    G --> H

    H --> I[Guest Chat Interface]
    I --> J[User Sends Message]

    J --> K[Generate Query Embedding<br/>text-embedding-3-large<br/>1024d]

    K --> L[Build Search Strategy]
    L --> M{Query Type?}

    M -->|Operational| N[Search Unit Manuals<br/>High Weight]
    M -->|Tourism| O[Search MUVA Content<br/>High Weight]
    M -->|General| P[Search All Domains<br/>Balanced]

    N --> Q[Execute Parallel Search]
    O --> Q
    P --> Q

    Q --> R[RPC: match_unit_manual_chunks]
    Q --> S[RPC: match_hotel_general_chunks]
    Q --> T[RPC: match_muva_content]

    R --> U[Merge Results<br/>Sort by Similarity]
    S --> U
    T --> U

    U --> V[Build Context<br/>Top 10-15 Chunks]
    V --> W[Generate Response<br/>Claude Sonnet 4]

    W --> X[Stream to Client]
    X --> I

    style A fill:#e1f5fe
    style H fill:#c8e6c9
    style K fill:#fff9c4
    style Q fill:#f8bbd0
    style W fill:#d1c4e9
    style X fill:#c8e6c9
