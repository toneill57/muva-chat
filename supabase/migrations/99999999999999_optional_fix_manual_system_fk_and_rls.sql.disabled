-- Migration: Fix accommodation manuals system - FK and RLS standardization
-- Environment: Staging first, then production
-- Author: Claude Code (Backend Agent)
-- Date: 2025-11-09
--
-- ISSUES FIXED:
-- 1. CRITICAL: manual_id FK points to wrong table (accommodation_units_manual vs accommodation_manuals)
-- 2. CRITICAL: RLS policies inconsistent (app.current_tenant_id vs app.tenant_id)
-- 3. MINOR: Duplicate index on accommodation_unit_id

BEGIN;

-- ============================================
-- 1. FIX FOREIGN KEY (CRITICAL)
-- ============================================

-- Drop incorrect FK that points to accommodation_units_manual(unit_id)
ALTER TABLE accommodation_units_manual_chunks
DROP CONSTRAINT IF EXISTS accommodation_units_manual_chunks_manual_id_fkey;

-- Create correct FK pointing to accommodation_manuals(id)
ALTER TABLE accommodation_units_manual_chunks
ADD CONSTRAINT accommodation_units_manual_chunks_manual_id_fkey
FOREIGN KEY (manual_id)
REFERENCES accommodation_manuals(id)
ON DELETE CASCADE;

-- ============================================
-- 2. STANDARDIZE RLS POLICIES (CRITICAL)
-- ============================================

-- Standardize accommodation_manuals to use 'app.tenant_id' (consistent with accommodation_units)
-- This ensures both tables in the manuals system use the same RLS configuration

-- Drop old policies
DROP POLICY IF EXISTS accommodation_manuals_tenant_isolation ON accommodation_manuals;
DROP POLICY IF EXISTS accommodation_manuals_insert ON accommodation_manuals;
DROP POLICY IF EXISTS accommodation_manuals_update ON accommodation_manuals;
DROP POLICY IF EXISTS accommodation_manuals_delete ON accommodation_manuals;

-- Recreate policies with standardized 'app.tenant_id'
CREATE POLICY accommodation_manuals_tenant_isolation
ON accommodation_manuals FOR SELECT
USING (
  tenant_id = current_setting('app.tenant_id', true)::uuid
  OR auth.role() = 'service_role'
);

CREATE POLICY accommodation_manuals_insert
ON accommodation_manuals FOR INSERT
WITH CHECK (true); -- Validation handled in application layer

CREATE POLICY accommodation_manuals_update
ON accommodation_manuals FOR UPDATE
USING (
  tenant_id = current_setting('app.tenant_id', true)::uuid
  OR auth.role() = 'service_role'
);

CREATE POLICY accommodation_manuals_delete
ON accommodation_manuals FOR DELETE
USING (
  tenant_id = current_setting('app.tenant_id', true)::uuid
  OR auth.role() = 'service_role'
);

-- ============================================
-- 3. OPTIMIZE INDICES (MINOR)
-- ============================================

-- Drop duplicate index on accommodation_unit_id
-- Both idx_manual_chunks_accommodation_unit_id and idx_manual_chunks_unit_id exist
DROP INDEX IF EXISTS idx_manual_chunks_unit_id;

-- ============================================
-- 4. VALIDATION COMMENTS
-- ============================================

COMMENT ON TABLE accommodation_manuals IS
'Stores uploaded accommodation manuals (markdown files) for processing into chunks.
RLS uses app.tenant_id for multi-tenant isolation.
Related table: accommodation_units_manual_chunks';

COMMENT ON TABLE accommodation_units_manual_chunks IS
'Stores processed chunks from accommodation manuals with Matryoshka embeddings.
Each chunk has 3 embedding dimensions: full (3072), balanced (1536), fast (1024).
RLS uses app.tenant_id for multi-tenant isolation.
Related table: accommodation_manuals';

COMMIT;
